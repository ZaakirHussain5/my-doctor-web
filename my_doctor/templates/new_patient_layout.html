{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="keywords" content="Flingo, Messaging app, chat, chat app" />

    <title>Doctor Plus Video and Chatting System</title>
    <link rel="stylesheet" href="{% static 'patients/assets/fonts/MaterialDesign/css/materialdesignicons.min.css' %}">
    <link rel="stylesheet" href="{% static 'patients/assets/vendors/perfect-scrollbar/perfect-scrollbar.css' %}">
    <link rel="stylesheet" href="{% static 'patients/assets/vendors/OwlCarousel2/owl.carousel.css' %}">
    <link rel="stylesheet" href="{% static 'patients/assets/vendors/bootstrap/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'patients/css/app.css' %}">
    <link rel="stylesheet" href="{% static 'patients/css/responsive.css' %}">
    <link rel="stylesheet" href="{% static 'patients/css/theme/default.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/bootstrap.datapicker.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" integrity="sha512-mSYUmp1HYZDFaVKK//63EcZq4iFWFjxSL+Z3T/aCt4IO9Cejm03q3NKKYN6pFQzY0SBOr8h+eCIAZHPXcpZaNw==" crossorigin="anonymous" />
    <link rel="stylesheet" href="{% static 'assets/css/toastr.min.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/datatables.net-bs4/css/dataTables.bootstrap4.min.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/datatables.net-buttons-bs4/css/buttons.bootstrap4.min.css' %}">
    <script src="{% static 'patients/assets/vendors/jquery/jquery-3.4.1.min.js' %}"></script>
    
</head>

<body class="light-default-theme">

    <div class="ca-main-conatiner">
        <div class="ca-main-wrapper">
            <div class="ca-sidebar-wrapper">
                <div class="ca-sidebar">
                    <div class="ca-sidebar__header">
                        <div class="ca-userprofile" data-toggle="modal" data-target="#viewProfileModal">
                            <a href="javascript:;">
                                <img src="{% static 'website/img/logo.png' %}" alt="">
                            </a>
                        </div>

                    </div>

                    {% include 'partials/_patient_nav.html'%}
                </div>
            </div>

            <div class="ca-content-wrapper">
                <div class="ca-content">
                    <div class="conversation-panel__head">
                        <div class="conversation-panel__back-button ">
                            <i class="mdi mdi-arrow-left"></i>
                        </div>

                        <div class="conversation-panel__avatar personalinfo-panel-opener">
                           
                        </div>
                        <div class="conversation__actions">
                            <div class="action-icon pr-5"  data-toggle="modal" data-target="#outGoingCall">
                                <i class="mdi mdi-bell-ring-outline mdi-36px"></i>
                            </div>
                            
                            

                            <div class="iconbox-dropdown dropdown">
                                <div class="iconbox btn-hovered-light mr-5" role="button" id="dropdownMenuLink2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <div class="user-avatar user-avatar-rounded">
                                        <img src="assets/images/user/500/02.jpg" alt="" id="Profile-pic">
                                    </div>
                                    <div class="conversation__name">
                                        <h6 id='conversation_doc' class="conversation__name--title d-lg-block d-none"></h6>
                                    </div>
                                </div>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink2">
                                    
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="/">
                                        <span><i class="mdi mdi-cancel"></i></span> 
                                        <span>logout</span>
                                    </a>
                                </div>
                            </div>                                                
                        </div>
                    </div>
                    {% block content %}
                    {% endblock %}
                </div>
            </div>


{% include 'patientsUI/_settings.html'%}
            <!-- THEME CUSTOMIZER -->
            <div class="theme-customizer">
                <div class="theme-customizer-opener">
                    <i class="theme-customizer-icon mdi mdi-settings"></i>
                </div>

                <div class="theme-customizer-content">

                    <h6 class="border-bottom pb-2">Light Theme</h6>
                    <a href="javascript:;" data-theme="light-default-theme" class="theme default-theme selected"></a>
                    <a href="javascript:;" data-theme="light-purple-theme" class="theme purple-theme"></a>
                    <a href="javascript:;" data-theme="light-pink-theme" class="theme pink-theme"></a>
                    <a href="javascript:;" data-theme="light-green-theme" class="theme green-theme"></a>
                    <a href="javascript:;" data-theme="light-red-theme" class="theme red-theme"></a>
                    <a href="javascript:;" data-theme="light-orange-theme" class="theme orange-theme"></a>
                    <a href="javascript:;" data-theme="light-blue-theme" class="theme blue-theme"></a>
                    <a href="javascript:;" data-theme="light-darkblue-theme" class="theme darkblue-theme"></a>
                    <a href="javascript:;" data-theme="light-lightpink-theme" class="theme lightpink-theme"></a>

                    <h6 class="border-bottom py-3">Dark Theme</h6>
                    <a href="javascript:;" data-theme="dark-default-theme" class="theme default-theme"></a>
                    <a href="javascript:;" data-theme="dark-purple-theme" class="theme purple-theme"></a>
                    <a href="javascript:;" data-theme="dark-pink-theme" class="theme pink-theme"></a>
                    <a href="javascript:;" data-theme="dark-green-theme" class="theme green-theme"></a>
                    <a href="javascript:;" data-theme="dark-red-theme" class="theme red-theme"></a>
                    <a href="javascript:;" data-theme="dark-orange-theme" class="theme orange-theme"></a>
                    <a href="javascript:;" data-theme="dark-blue-theme" class="theme blue-theme"></a>
                    <a href="javascript:;" data-theme="dark-darkblue-theme" class="theme darkblue-theme"></a>
                    <a href="javascript:;" data-theme="dark-lightpink-theme" class="theme lightpink-theme"></a>


                    <h6 class="border-bottom py-3">RTL Layout</h6>
                    <label class="material-switch">
                        <input type="checkbox" class="rtlSwitch">
                        <span></span>
                    </label>
                </div>

            </div>

            <div class="backdrop-overlay hidden"></div>
        </div>
    </div>

    <div class="modal calling-modal CallDialogFullscreen-sm" id="incomingVideoCall" tabindex="-1" role="dialog" aria-labelledby="incomingVideoCall" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="text-center">
                        <div class="user-avatar user-avatar-rounded user-avatar-xl">
                            <img src="/media/logos/anonymous-user.png" alt="">
                        </div>
                        <div class="userprofile-name">
                            <span>Incoming Call</span>
                            <h4 id="DoctorName"></h4>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col">
                            <button class="btn btn-danger btn-block" id="hangupBtn"><i class="fa fa-phone" style="transform: rotate(140deg)"></i> Ignore</button>
                        </div>
                        <div class="col">
                            <a id="answerCall" class="btn btn-success btn-block" ><i class="fa fa-phone"> Accept</i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="myAudio">
        <source src="{% static 'video/skype_ringtone.mp3' %}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    <script src="{% static 'assets/js/jquery.cookie.js' %}"></script>
    <script src="{% static 'patients/assets/vendors/bootstrap/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'patients/assets/vendors/material-floating-button/dist/mfb.min.js' %}"></script>
    <script src="{% static 'patients/assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js' %}"></script>
    <script src="{% static 'patients/assets/vendors/OwlCarousel2/owl.carousel.min.js' %}"></script>
    <script src="{% static 'patients/js/app.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" integrity="sha512-T/tUfKSV1bihCnd+MxKD0Hm1uBBroVYBOYSk1knyvQ9VyZJpc/ALb4P0r6ubwVPSGB2GvjeoMAJJImBG12TiaQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js" integrity="sha512-rmZcZsyhe0/MAjquhTgiUcb4d9knaFc7b5xAfju483gbEXTkeJRUMIPk6s3ySZMYUHEcjKbjLjyddGWMrNEvZg==" crossorigin="anonymous"></script>
    <script src="{% static 'assets/js/toastr.min.js' %}"></script>
    <script src="{% static 'vendors/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'vendors/datatables.net-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'vendors/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script>
        $(document).ready(function () {
            $('.click-me').click(function () {
                $('.ca-main-wrapper .ca-sidebar-wrapper').toggleClass('fliph');
                $('.ca-main-conatiner').toggleClass('flipsmall');

            });
        });
    </script>
    {% block scripts %}

    {% endblock %}
    <script>
        $(document).ready(function(){
        function formDeserialize(form, data) {
        const entries = (new URLSearchParams(data)).entries();
        for (const [key, val] of entries) {
            const input = form.elements[key];
            if (input != undefined) {
                if (input.type == 'file') {
                    if (val) {
                        var $file = jQuery('#' + input.id),
                            $label = $file.next('img'),
                            $labelText = $label.find('span'),
                            labelDefault = $labelText.text();
                        var filename = val.split('/').pop()
                        if (filename) {
                            $label
                                .addClass('file-ok')
                                .attr('src', val);
                            $labelText.text(filename);
                        } else {
                            $label.removeClass('file-ok');
                            $labelText.text(labelDefault);
                        }
                    }
                    
                } else {
    
                    switch (input.type) {
                        case 'checkbox':
                            input.checked = !!val;
                            break;
                        case 'select-one':
                            if (val)
                                input.value = val;
                            else
                                input.selectedIndex = 0;
    
                            break;
                        default:
                            input.value = val;
                            break;
    
                    }
    
                }
            }
    
        }
    }
    function previewFile(input){
        var file = $("input[type=file]").get(0).files[0];
 
        if(file){
            var reader = new FileReader();
 
            reader.onload = function(){
                $("#previewImg").attr("src", reader.result);
            }
 
            reader.readAsDataURL(file);
        }
    }
    $('#profile_pic').change(function(){
        previewFile(this);
    })

    function getPatientData(){
        const profileForm = document.getElementById('profile-form');
        $.ajax({
            url: '/api/getLoggedInPatient',
            method: 'GET',
            contendType: 'application/json',
            'async': false,
            'method': 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Token " + $.cookie('Token'));
            },
        }).done((response)=>{
            $.ajax({
                url: "/api/getEmail",
                method: 'GET',
                contendType: 'application/json',
                async: false,
                method: 'GET',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Token " + $.cookie('Token'));
            },
            }).done((response)=>{
                formDeserialize(profileForm, response);
            
            })
            formDeserialize(profileForm, response);
            $('#conversation_doc').html(response.full_name)
            $('#Profile-pic').attr('src',response.profile_pic)
            $('#username').val($('#ph_no').val())
        })
    }
    getPatientData()

$('#ph_no').change(function(){

    $('#username').val($(this).val())
})
 

    $("#profile-form").submit((e)=>{
        e.preventDefault();
        e.stopImmediatePropagation();
        const data = new FormData(document.getElementById('profile-form'))
        console.log(data);
        $.ajax({
        url: '/api/PatientUpdateProfile',
        data:data,
        method: 'POST',
        contentType: false,
        processData: false,
        beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Token " + $.cookie('Token'));
        },
    }).done((response)=>{
        console.log("postrequest response -", response);
    }).fail((error)=>{
        console.log(error);
    })
    })

$('#password_form').submit((e)=>{
    console.log('password form submit');
        e.preventDefault();
        e.stopImmediatePropagation();
        const data = new FormData(document.getElementById('password_form'))
       $.ajax({
            url: '/api/changePassword',
            method: 'POST',
            data: data,
            contentType: false,
            processData: false,
            beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Token " + $.cookie('Token'));
           },
        }).done((response)=>{
           console.log(response);
           window.location.href = '/login'
        }).fail((error)=>{
           console.log('errors are ', error)
      })


    })
    







    })
    </script>

<script>
    function checkForCall() {
        
        jQuery.ajax({
            'url': '/api/vedioChatOparetion/?user=pat',
            'contentType': 'application/json',
            'async': false,
            'method': 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Token " + jQuery.cookie('Token'));
            },
        }).done((response) => {
            console.log(response)
            var list = response;
            var x = document.getElementById("myAudio");
            if (list && list.length > 0) {
                x.loop = true;
                x.play()
                jQuery('#hangupBtn').attr('data-id', list[0].id)
                jQuery('#DoctorName').html(list[0].caller_name)
                jQuery('#answerCall').attr('href', `/api/VideoCall?session=${list[0].id}&user=pat&doctor=${list[0].caller_ID}`)
                jQuery('#incomingVideoCall').modal('show')
            }
            else
            {
                jQuery('#incomingVideoCall').modal('hide')
            }
        });

    }

    jQuery('#hangupBtn').click(function () {
        jQuery.ajax({
            'url': '/api/vedioChatOparetion/' + jQuery(this).attr('data-id') +'/',
            'method': 'DELETE',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Token " + jQuery.cookie('Token'));
            },
        }).done((response) => {
            console.log(response)
            var x = document.getElementById("myAudio");
            x.pause();
            x.currentTime = 0;
            jQuery('#incomingVideoCall').modal('hide')
        }).fail((response) => {
            console.log(response)
        })
    })

    setInterval(function () {
        checkForCall();
    }, 2000); 
</script>
</body>

</html>