{% extends 'new_patient_layout.html'%}
{% load static%}
{% block content %}
<div class="ca-content__chatstab">

    <div class="ca-content__callstab" style="padding-top: 0;">
        <div class="conversation-panel__body ps" style="height: calc(100vh - 0.6875rem);">
            <div class="container">
                <div class="card">
                    <div class="card-header">
                        <h4>Book a Consultation in 5 easy Steps</h4>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-pills  nav-justified" id="pills-tab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#spl-select"
                                    role="tab" aria-controls="pills-home" aria-selected="true">1. Select Speciality</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#date-selection"
                                    role="tab" aria-controls="pills-profile" aria-selected="false">2. Select Date</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-contact-tab" data-toggle="pill" href="#select-doctor"
                                    role="tab" aria-controls="pills-contact" aria-selected="false">3. Select Doctor</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-payment-tab" data-toggle="pill" href="#payment" role="tab"
                                    aria-controls="pills-contact" aria-selected="false">4. Payment</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="pills-contact-tab" data-toggle="pill" href="#Confirmation"
                                    role="tab" aria-controls="pills-contact" aria-selected="false">5. Confirmation</a>
                            </li>
                        </ul>
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="spl-select" role="tabpanel"
                                aria-labelledby="pills-home-tab">

                                <div class="ca-call-details-history spl-list" id="spl-list">
                                    <div class="container-fluid">
                                        {% for spaciality in  specialist %}
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="ca-call-history">
                                                    <div class="ca-call-history__left">
                                                        <div class="user-avatar user-avatar-rounded mt-3 img-div">
                                                            <img class="img-fluid" src={{spaciality.icon.url}} alt="">
                                                        </div>
                                                        <div class="ml-2 ca-call-history__left--title text-div">

                                                            <h5>{{ spaciality.special_type }}</h5>
                                                            <span class="font-weight-bold text-secondary">
                                                                {{ spaciality.description }}
                                                            </span>

                                                        </div>
                                                    </div>
                                                    <div class="ca-call-history__right">
                                                        <button type="button" id="{{spaciality.id}}"
                                                            class="select btn iconbox btn-solid-info text-white bookAppointment">
                                                            Select
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}

                                    </div>

                                </div>
                            </div>
                            <div class="tab-pane fade" id="date-selection" role="tabpanel"
                                aria-labelledby="pills-profile-tab">
                                <div class="spl-list">
                                    <div class="container">
                                        <div class="form-group row">
                                            <input type="hidden" id="spl-selected">
                                            <div class="offset-md-2 col-md-7">
                                                
                                                <div class="" id="dateSelector">
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <div id="datepicker"></div>
                                                            <input type="hidden" id="App_date">
                                                        </div>
                                                        <div class="col-md-4">
                                                             <button type="button" class="btn mfb-component__button--main"
                                                            style="width:100%; border-radius:30px" id="selectToday">
                                                            Today
                                                        </button>
                                                          <button type="button"
                                                            class="btn mfb-component__button--main mt-1"
                                                            style="width:100%;  border-radius:30px" id="selectTommorow">
                                                            Tommorow
                                                        </button>  
                                                        </div>
                                                        <div class="col-md-12">
                                                            <input type="text" class="form-control text-center"
                                                        placeholder="Selected Date" id="dateSelected"
                                                        style=" border-radius:30px">
                                                    <button type="button"
                                                        class="btn btn-block mfb-component__button--main mt-2"
                                                        style=" width:100%; border-radius:30px"
                                                        id="btnProceed">Proceed</button>
                                                        </div>
                                                    </div>
                                                    
                                                </div>



                                            </div>
                                           

                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="tab-pane fade" id="select-doctor" role="tabpanel"
                                aria-labelledby="pills-contact-tab">
                                <div class="ca-call-details-history" id="doctors-list">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="ca-call-history">
                                                <div class="ca-call-history__left">
                                                    <div class="user-avatar user-avatar-rounded">
                                                        <img class="img-fluid" src="assets/images/layer-14@2x.png"
                                                            alt="">
                                                    </div>
                                                    <div class="ml-2 ca-call-history__left--title">
                                                        <div>Dr. John Doe</div>
                                                        <span class="font-weight-bold text-success">Available Time :
                                                            10:20 AM</span>
                                                        <br>
                                                        <span class="font-weight-bold text-success">Consultation Fee :
                                                            400/-</span>
                                                    </div>
                                                </div>
                                                <div class="ca-call-history__right">
                                                    <button type="button" data-doctor="${item.doctor.full_name}"
                                                        data-doctor-id="${item.doctor.id}"
                                                        data-image="${item.doctor.profile_pic}"
                                                        data-app-date="${$('#date-val').html()}"
                                                        data-time="${item.from_time}" data-fee="${consFee}"
                                                        class="btn iconbox btn-solid-info text-white bookAppointment">
                                                        Book Appointment
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="payment" role="tabpanel" aria-labelledby="pills-contact-tab">
                                <div class="spl-list">
                                    <div class="container">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="row">
                                                    <div class="col-md-12">

                                                        <ul class="list-unstyled">
                                                            <li>
                                                                <div class="ps-list">
                                                                    <div class="ps-list__left">
                                                                        <div class="ps-list__left--icon"></div>
                                                                        <div class="ps-list__left--name">Doctor</div>
                                                                    </div>
                                                                    <div class="ps-list__right" id="Doctor">Dr. Kumari
                                                                    </div>
                                                                    <input type="hidden" id="doctor-id">
                                                                </div>
                                                            </li>
                                                            <li>
                                                                <div class="ps-list">
                                                                    <div class="ps-list__left">
                                                                        <div class="ps-list__left--icon"></div>
                                                                        <div class="ps-list__left--name">Appointment
                                                                            Date</div>
                                                                    </div>
                                                                    <div class="ps-list__right" id="app-date">10/12/2020
                                                                    </div>
                                                                </div>
                                                            </li>
                                                            <li>
                                                                <div class="ps-list">
                                                                    <div class="ps-list__left">
                                                                        <div class="ps-list__left--icon"></div>
                                                                        <div class="ps-list__left--name">Appointment
                                                                            Time</div>
                                                                    </div>
                                                                    <div class="ps-list__right" id="app-time">12:00 AM
                                                                    </div>
                                                                </div>
                                                            </li>
                                                            <li>
                                                                <div class="ps-list">
                                                                    <div class="ps-list__left">
                                                                        <div class="ps-list__left--icon"></div>
                                                                        <div class="ps-list__left--name">Description
                                                                        </div>
                                                                    </div>
                                                                    <div class="ps-list__right" id="consultingAbout">For
                                                                        cold and Cough</div>
                                                                </div>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="spl-list" style="height: 150px;">
                                                    <ul id="subsPlans" class="list-unstyled">
                                                        
                                                        <li>
                                                            <div class="ps-list">
                                                                <div class="ps-list__left">
                                                                    <div class="ps-list__left--icon"><input type="radio"
                                                                            name="SubsPlan"></div>
                                                                    <div class="ps-list__left--name">Unlimited for 30
                                                                        Days</div>
                                                                </div>
                                                                <div class="ps-list__right" id="amount">Rs. 2500.00
                                                                </div>
                                                            </div>
                                                        </li>
                                                        <li>
                                                            <div class="ps-list">
                                                                <div class="ps-list__left">
                                                                    <div class="ps-list__left--icon"><input type="radio"
                                                                            name="SubsPlan"></div>
                                                                    <div class="ps-list__left--name">Unlimited for 180
                                                                        Days</div>
                                                                </div>
                                                                <div class="ps-list__right" id="amount">Rs. 6000.00
                                                                </div>
                                                            </div>
                                                        </li>
                                                        <li>
                                                            <div class="ps-list">
                                                                <div class="ps-list__left">
                                                                    <div class="ps-list__left--icon"><input type="radio"
                                                                            name="SubsPlan"></div>
                                                                    <div class="ps-list__left--name">Unlimited for 180
                                                                        Days</div>
                                                                </div>
                                                                <div class="ps-list__right" id="amount">Rs. 6000.00
                                                                </div>
                                                            </div>
                                                        </li>
                                                        <li>
                                                            <div class="ps-list">
                                                                <div class="ps-list__left">
                                                                    <div class="ps-list__left--icon"><input type="radio"
                                                                            name="SubsPlan"></div>
                                                                    <div class="ps-list__left--name">Unlimited for 180
                                                                        Days</div>
                                                                </div>
                                                                <div class="ps-list__right" id="amount">Rs. 6000.00
                                                                </div>
                                                            </div>
                                                        </li>

                                                    </ul>

                                                </div>
                                                <div class="card">
                                                    <div class="card-header">
                                                        Payable Amount
                                                    </div>
                                                    <div class="card-body text-center">
                                                        <h2>
                                                            <i class="mdi mdi-currency-inr"></i> 300.00
                                                        </h2>
                                                    </div>
                                                    <div class="card-footer">
                                                        <button type="button" class="btn mfb-component__button--main"
                                                            style="width:100%;  border-radius:30px">
                                                            Pay Securely
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="Confirmation" role="tabpanel"
                                aria-labelledby="pills-contact-tab">
                                <div class="spl-list">
                                    <div class="container">
                                        <div class="row">
                                            <div class="col-md-8 offset-md-2">
                                                <div class="ca-profile-thumb" style="height: auto;">

                                                    <div class="ca-profile-info">
                                                        <div class="ca-profile-pic"><img class="img-fluid"
                                                                id="summaryProfile" src="assets/images/layer-14@2x.png"
                                                                alt=""></div>
                                                    </div>

                                                    <div class="ca-overlay"></div>
                                                </div>
                                                <div class="text-center mt-5">
                                                    <h5>Appointment Confirmed</h5>
                                                    <p>Your appointment with <strong>Dr. Kumari</strong> has been fixed
                                                        for <strong>10/12/2020</strong> at <strong>12:00 PM</strong> you
                                                        will be notified 15 minutes prior your consultation</p>
                                                </div>
                                                <div class="card">
                                                    <div class="card-header">
                                                        Paid Amount
                                                    </div>
                                                    <div class="card-body text-center">
                                                        <h4>
                                                            <i class="mdi mdi-currency-inr"></i> 450.00
                                                        </h4>
                                                    </div>
                                                    <div class="card-footer">
                                                        <button type="button" class="btn mfb-component__button--main"
                                                            style="width:100%;  border-radius:30px">
                                                            Done
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<div class="modal new-message-dialog" id="ConsultationDetails" tabindex="-1" role="dialog" aria-labelledby="newMsgModal"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                       
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="ca-profile-thumb" style="height: auto;">
                            <div class="ca-profile-info">
                                <div class="ca-profile-pic">
                                    <img class="img-fluid" src="assets/images/user/500/01.jpg" alt="" id="docImage"></div>
                                <div class="ca-profile-title">
                                    <h2 class="ca-profile-name"></h2>
                                </div>
                            </div>
                            <div class="ca-overlay"></div>
                        </div>
                        <div class="form-group mt-5">
                            <input type="hidden" id="docName">
                            <input type="hidden" id="docId">
                            <input type="hidden" id="appDate">
                            <input type="hidden" id="time">
                            <input type="hidden" id="fee">
                            <h4><label for="ConsultingAbout">Consulting About</label></h4>
                            <textarea class="form-control" id="ConsultingAbout" rows="10" placeholder="Describe your Problem" style="font-size: medium;"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn mfb-component__button--main"
                        style="width:100%; border-radius:30px" id="ConfirmClick">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
<script>
    console.log('Hello world')
    $(document).ready(function () {
        $('#caMainTab a[href="{% url "patients:appointments"%}"]').addClass('active');
        // VARIABLES...
        let speciality_type = 0;
        $(".select").click(function () {
            console.log('clicked')
            speciality_type = $(this).attr('id');
            $('#pills-home-tab').removeClass('active');
            $('#spl-select').removeClass('active show');

            $('#pills-profile-tab').addClass('active');
            $('#date-selection').addClass('active show');
            console.log(speciality_type)
        })

        $('#selectToday').click(function () {
            let today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
            const yyyy = today.getFullYear();

            today = mm + '/' + dd + '/' + yyyy;
            $('#dateSelected').val(today)
        })

        const nextDate = () => {
            const date = new Date();
            return new Date(date.setDate(date.getDate() + 1)).toLocaleDateString();
        };
        $('#selectTommorow').click(() => {
            $('#dateSelected').val(nextDate())
        });
        let appointment_time = '';
        let doc_id = '';
        $('#doctors-list').on('click', '.selectDorctorsd', function(){
            var button = $(this)
            $('#docImage').attr('src', button.attr('data-image'))
            appointment_time = button.attr('data-time')
            doc_id = button.attr('data-doctor-id')
            $('#ConsultationDetails').modal('show')
            
        });

        $('#ConfirmClick').click(()=>{
            
            $('#pills-contact-tab').removeClass('active');
            $('#select-doctor').removeClass('active show');
            // $('#ConsultationDetails').removeClass('show')
            $('#pills-payment-tab').addClass('active');
            $('#payment').addClass('active show');
            $('#ConsultationDetails').modal('hide')
            $('#consultingAbout').html($('#ConsultingAbout').val())
            $('#app-date').html($('#dateSelected').val())
            $('#app-time').html(appointment_time);
            console.log($('#docFName'+doc_id).html())
            $('#Doctor').html($('#docFName'+doc_id).html());
            get_subcription_plan()
        })

        
        $('#btnProceed').click(() => {
            let date = $('#dateSelected').val()
            $.ajax({
                url: "/api/patientAppointment/DoctorAvailable?date=" + date + "&&id=" + speciality_type,
                method: 'GET',
                contentType: 'Application/json'
            }).done((response) => {
                $('#pills-profile-tab').removeClass('active');
                $('#date-selection').removeClass('active show');

                $('#pills-contact-tab').addClass('active');
                $('#select-doctor').addClass('active show');
                let doctor_list = '';
                for (let i = 0; i < response.length; i++) {
                    let data = response[i];
                    console.log(data)
                    let strings = `
                    <div class="card">
                        <div class="card-body">
                            <div class="ca-call-history">
                                <div class="ca-call-history__left">
                                    <div class="user-avatar user-avatar-rounded">
                                        <img class="img-fluid" src="${data.doctor.profile_pic}"
                                            alt="">
                                    </div>
                                    <div class="ml-2 ca-call-history__left--title">
                                        <div id='docFName${data.doctor.id}'>${data.doctor.full_name}</div>
                                        <span class="font-weight-bold text-success">Available Time :
                                            ${data.from_time}</span>
                                        <br>
                                        <span class="font-weight-bold text-success">Consultation Fee :
                                            ${data['doctor']['consultation_fee']}/-</span>
                                    </div>
                                </div>
                                <div class="ca-call-history__right">
                                    <button type="button" data-doctor="${data.doctor.full_name}"
                                        data-doctor-id="${data.doctor.id}"
                                        data-image="${data.doctor.profile_pic}"
                                        data-app-date="${$('#date-val').html()}"
                                        data-time="${data.from_time}" data-fee="${data['doctor']['consultation_fee']}"
                                        
                                        class="btn selectDorctorsd iconbox btn-solid-info text-white bookAppointment">
                                        Book Appointment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    doctor_list += strings;
                }
                $('#doctors-list').html(doctor_list)
            }).fail((err) => {
                console.log(err)
            })
        })

        function get_subcription_plan(){
            let li = `<li>
                        <div class="ps-list">
                            <div class="ps-list__left">
                                <div class="ps-list__left--icon">
                                    <input chacked=true type="radio" name="SubsPlan">
                                </div>
                                <div class="ps-list__left--name">One Time
                                    Consultation</div>
                            </div>
                            <div class="ps-list__right" id="amount">Rs 300.00</div>
                        </div>
                    </li>`;

            $.ajax({
                'url': '/api/subscription_plans',
                'contentType': 'application/json',
                'async': false,
                'method': 'GET'
            }).done((response)=>{
                console.log(response)
                for(let i=0; i < response.length; i++){
                    let data = response[i];
                    let make_li = `
                    <li>
                        <div class="ps-list">
                            <div class="ps-list__left">
                                <div class="ps-list__left--icon">
                                    <input chacked=true type="radio" name="SubsPlan">
                                </div>
                                <div class="ps-list__left--name">${data.plan_name}</div>
                            </div>
                            <div class="ps-list__right" id="amount">Rs ${data.plan_price}</div>
                        </div>
                    </li>
                    
                    `;
                    li += make_li;
                }
                $('#subsPlans').html(li)
            }).fail((error)=>{
                console.log(error)
            })
        }

        $('#datepicker').datepicker({
              format:"dd/mm/yyyy"
            });
            $('#datepicker').on('changeDate', function () {
                $('#App_date').val(
                    $('#datepicker').datepicker('getFormattedDate')
                );
                $('#dateSelected').val(
                    $('#datepicker').datepicker('getFormattedDate')
                );
            });

            $('#datepicker table').removeClass('table-condensed')
            $('#datepicker table').addClass('table')

            

            $('#selectToday').click(function(){
                $('#dateSelected').val(
                    moment(new Date()).format("DD/MM/YYYY")
                );
            })

            $('#selectTommorow').click(function(){
                $('#dateSelected').val(
                    moment(new Date()).add(1, 'days').calendar().format("DD/MM/YYYY")
                );
            })

        ///////////// payment ///////////////
/* document.getElementById('rzp-button1').onclick = function(e){
   var options = {
    "key": "rzp_test_Sh4geUmypYkfzX", // Enter the Key ID generated from the Dashboard
    "amount": parseFloat($('#amount').html())*100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Doctor Plus",
    "description": "Online Doctor Appointment",
    "image": "{% static 'assets/img/login.jpg'%}",
    "handler": function (response) {
            
        // implement in booking appoinment
        var payment_id = response.razorpay_payment_id;
            var data = {
                appointment_date:  $('#app-date').html(),
                appointment_time: $('#app-time').html(),
                doctor: $('#doctor-id').val(),
                Description:  $('#consultingAbout').html(),
                consultation_status: "Pending",
                payment_type: "UPI",
                payment_id: payment_id,
                paid_amount: $('#amount').html()
            };
            // '/Authorization Token {value}/appoinments/'
            $.ajax({
                'url': '/api/appointments/',
                'method': 'POST',
                'contentType': 'application/json',
                'data': JSON.stringify(data),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Token " + $.cookie('Token'));
                },
            }).done((response) => {
                   console.log(response);
                   setTimeout(function(){
                       window.location.href='/patients/dashboard'
                   },200)
                   toastr.success("Appointmnt booked Successfully","Success",{positionClass:"toast-top-center"})
            }).fail((err, error, wrong) => {
                console.log(err)
            })
        },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#007bff"
    }
};
var rzp1 = new Razorpay(options);
    rzp1.open();
    e.preventDefault();
}*/
    }) 
    
</script>
{% endblock %}