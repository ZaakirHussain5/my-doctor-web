{% extends 'patients_layout.html'%}
{% load static%}
{% block sideContent %}
<div class="tab-content" id="caMainTabContent">

    <div class="tab-pane fade show active" id="caChats" role="tabpanel" aria-labelledby="caChatsTab">
        <div class="nav-style-2">
            <div class="tab-content" id="caChatsTabInsideContent">
                <div class="tab-pane fade show active" id="personal-chat" role="tabpanel" aria-labelledby="personal-chat-tab">
                    <div class="sidebar-userlist">
                        <ul id="consultation_doctor_list" class="list-unstyled">
                            <li>
                                <div class="conversation active">
                                    <div class="user-avatar user-avatar-rounded offline">
                                        <img src="{% static 'patients/assets/images/layer-14@2x.png' %}" alt="">
                                    </div>
                                    <div class="conversation__details">
                                        <div class="conversation__name">
                                            <div class="conversation__name--title">Dr. Kumari</div>
                                            <div class="conversation__time">yesterday</div>
                                        </div>
                                        <div class="conversation__message">
                                            <div class="conversation__message-preview">

                                                Hello! Are you free today?
                                            </div>                                                                        
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
{% block content %} 
<div class="ca-content-wrapper">
    <div class="ca-content">
        <div class="">
            <div class="ca-content__chatstab--personal">
                <div class="conversation-wrapper">
                    <div class="conversation-panel">
                        <div class="conversation-panel__head">
                            <div class="conversation-panel__back-button ">
                                <i class="mdi mdi-arrow-left"></i>
                            </div>

                            <div class="conversation-panel__avatar personalinfo-panel-opener">
                                <div class="user-avatar user-avatar-rounded">
                                    <img src="{% static 'patients/assets/images/layer-14@2x.png' %}" alt="">
                                </div>
                                <div class="conversation__name">
                                    <div id='conversation_doc' class="conversation__name--title">Dr. Kumari()</div>
                                    <div class="conversation__time">last seen at 07:15 PM</div>
                                </div>
                            </div>
                            <div class="conversation__actions">
                                <div class="action-icon"  data-toggle="modal" data-target="#outGoingCall">
                                    <i class="mdi mdi-phone"></i>
                                </div>
                                <div class="action-icon" data-toggle="modal" data-target="#incomingVideoStart">
                                    <i class="mdi mdi-video-outline"></i>
                                </div>

                                <div class="iconbox-dropdown dropdown">
                                    <div class="iconbox btn-hovered-light" role="button" id="dropdownMenuLink2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="iconbox__icon mdi mdi-dots-vertical"></i>
                                    </div>
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink2">
                                        <a class="dropdown-item personalinfo-panel-opener" href="javascript:;">
                                            <span><i class="mdi mdi-information-outline"></i></span> 
                                            <span>View Contact</span>
                                        </a>
                                        <a class="dropdown-item" href="javascript:;">
                                            <span><i class="mdi mdi-magnify"></i></span> 
                                            <span>Search</span>
                                        </a>
                                        <a class="dropdown-item" href="javascript:;">
                                            <span><i class="mdi mdi-volume-mute"></i></span> 
                                            <span>Mute notifications</span>
                                        </a>
                                        <a class="dropdown-item" href="javascript:;">
                                            <span><i class="mdi mdi-wallpaper"></i></span> 
                                            <span>Wallpaper</span>
                                        </a>
                                        <a class="dropdown-item" href="javascript:;">
                                            <span><i class="mdi mdi-notification-clear-all"></i></span> 
                                            <span>Clear Chat</span>
                                        </a>
                                        <a class="dropdown-item" href="javascript:;">
                                            <span><i class="mdi mdi-export-variant"></i></span> 
                                            <span>Export Chat</span>
                                        </a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="javascript:;">
                                            <span><i class="mdi mdi-cancel"></i></span> 
                                            <span>Block</span>
                                        </a>
                                    </div>
                                </div>                                                
                            </div>
                        </div>

                        <div class="conversation-panel__body">
                            <div class="container">
                                <div id="chatDiv" class="chatstyle-01">

<!--                                    <div class="ca-send">-->
<!--                                        <div class="ca-send__msg-group">-->
<!--                                            <div class="ca-send__msgwrapper">-->
<!--                                                <div class="ca-send__msg">Hi Marie, welcome to Live Chat! My name is Jason. How can I help you today?</div>-->
<!--                                            </div>-->
<!--                                            <div class="metadata">-->
<!--                                                <span class="time">10:10 AM</span>-->
<!--                                                <span class="tick">-->
<!--                                                    <img src="{% static 'patients/assets/images/tick/tick-read.svg" alt="">-->
<!--                                                </span>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                       -->
<!--                                        <div class="user-avatar user-avatar-sm user-avatar-rounded online">-->
<!--                                            <img src="{% static 'patients/assets/images/user/250/02.jpg' %}" alt="">-->
<!--                                        </div>-->
<!--                                    </div>-->

<!--                                    <div class="ca-received">-->
<!--                                        <div class="user-avatar user-avatar-sm user-avatar-rounded online">-->
<!--                                            <img src="{% static 'patients/assets/images/layer-14@2x.png' %}" alt="">-->
<!--                                        </div>-->
<!--                                        <div class="ca-received__msg-group">-->
<!--                                            <div class="ca-received__msgwrapper">-->
<!--                                                <div class="ca-received__msg">Hi, I wanted to check my order status. My order number is 0009483021 ðŸ˜€</div>-->

<!--                                            </div>-->
<!--                                            <div class="metadata">-->
<!--                                                <span class="time">10:10 AM</span>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->

                                </div>
                            </div>
                        </div>

                        <div class="conversation-panel__footer">
                            <div class="composer">
<!--                                <div class="composer__left">-->
<!--                                    <div class="composer__left&#45;&#45;sticker">-->
<!--                                        <i class="mdi mdi-sticker-emoji"></i>-->
<!--                                    </div>-->
<!--                                    <div class="composer__left&#45;&#45;emoticon">-->
<!--                                        <i class="mdi mdi-emoticon-outline"></i>-->
<!--                                    </div>     -->
<!--                                </div>-->

                                <div class="composer__middle">
                                    <form id="messege_form">
                                        <textarea id="typed-message" class="form-control" rows="1" placeholder="Type a message..."></textarea>
                                    </form>
                                    <div class="composer__middle--microphone">
                                        <i class="mdi mdi-camera"></i>
                                    </div>
<!--                                    <div class="composer__middle&#45;&#45;photo">-->
<!--                                        <i class="mdi mdi-camera"></i>-->
<!--                                    </div>-->
<!--                                    <div class="composer__middle&#45;&#45;attachment">-->
<!--                                        <i class="mdi mdi-camera"></i>-->
<!--                                    </div>-->
                                </div>

                                <div class="composer__right">
                                    <div id="sendButton" class="composer__right--send">
                                        <i class="mdi mdi-send"></i>
                                    </div>
                                    <div class="composer__right--microphone">
                                        <i class="mdi mdi-microphone"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="information-panel personal-information-panel">
                        <div class="information-panel__head">
                            <h5>Contact info</h5>
                            <div class="information-panel__closer">
                                <i class="mdi mdi-close"></i>
                            </div>
                        </div>
        
                        <div class="information-panel__body">
                            <div class="userprofile-avatar">
                                <img class="img-fluid" src="{% static 'patients/assets/images/layer-14@2x.png' %}" alt="">
                            </div>
        
                            <div class="userprofile-name">
                                <h4>Jack P. Angulo</h4>
                                <span>Product Manager</span>
                                <div class="social-icon-box">
                                    <div class="social-icon">
                                        <i class="mdi mdi-facebook"></i>
                                    </div>
                                    <div class="social-icon">
                                        <i class="mdi mdi-linkedin"></i>
                                    </div>
                                    <div class="social-icon">
                                        <i class="mdi mdi-twitter"></i>
                                    </div>
                                    <div class="social-icon">
                                        <i class="mdi mdi-youtube"></i>
                                    </div>
                                </div>
                            </div>
        
                            <hr>
        
                            <table class="table table-sm table-borderless user-table-info">
                                <tr>
                                    <td><i class="mdi mdi-cellphone-android"></i></td>
                                    <td>+91 99041-99041</td>
                                </tr>
                                <tr>
                                    <td><i class="mdi mdi-web"></i></td>
                                    <td>www.jackangulo.com</td>
                                </tr>
                                <tr>
                                    <td><i class="mdi mdi-map-marker"></i></td>
                                    <td>2519  Burnside Court, HORICON, WI, 53032</td>
                                </tr>
                            </table>
        
                            <hr>
        
                            <div class="accordion accordion-ungrouped mb-3" id="accordionExample">
                                <div class="card">
                                    <div class="card-header" id="headingOne">
                                        <div class="card-title" data-toggle="collapse" role="button"  data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            <div class="acpanel__heading">
                                                <div class="acpanel__left">
                                                    <span><i class="mdi mdi-camera-outline"></i></span>
                                                    <span>Photos & Media</span>
                                                </div>
                                                <div class="acpanel__right">
                                                    <span class="badge badge-info">26</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            
                                    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
                                        <div class="card-body">
                                            <div class="owl-carousel">
                                                <div class="item">
                                                    <img class="img-fluid" src="{% static 'patients/assets/images/media/01.jpg' %}" alt="">
                                                </div>
                                                <div class="item">
                                                    <img class="img-fluid" src="{% static 'patients/assets/images/media/02.jpg' %}" alt="">
                                                </div>
                                                <div class="item">
                                                    <img class="img-fluid" src="{% static 'patients/assets/images/media/03.jpg' %}" alt="">
                                                </div>
                                                <div class="item">
                                                    <img class="img-fluid" src="{% static 'patients/assets/images/media/04.jpg' %}" alt="">
                                                </div>
                                                <div class="item">
                                                    <img class="img-fluid" src="{% static 'patients/assets/images/media/05.jpg' %}" alt="">
                                                </div>
                                                <div class="item">
                                                    <img class="img-fluid" src="{% static 'patients/assets/images/media/06.jpg' %}" alt="">
                                                </div>
                                            </div>                                                                                                          
                                        </div>
                                    </div>
                                </div>
        
                                <div class="card">
                                    <div class="card-header" id="headingTwo">
                                        <div class="card-title collapsed d-flex justify-content-between align-items-center"  role="button" data-toggle="collapse" data-target="#collapseTwo"
                                            aria-expanded="false" aria-controls="collapseTwo">
                                            <div class="acpanel__heading">
                                                <div class="acpanel__left">
                                                    <span><i class="mdi mdi-file-document-outline"></i></span>
                                                    <span>Documents</span>
                                                </div>
                                                <div class="acpanel__right">
                                                    <span class="badge badge-info">16</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                                        <div class="card-body">
                                            <ul class="list-unstyled documentlist-wrapper">
                                                <li>
                                                    <div class="doclist">
                                                        <div class="docicon">
<!--                                                            <img src="{% static 'patients/assets/images/svg/pdf.svg" alt="">-->
                                                        </div>
                                                        <div class="doctitle">
                                                            <div class="docname">example-file.pdf</div>
                                                            <div class="docsize">217kb</div>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="doclist">
                                                        <div class="docicon">
<!--                                                            <img src="{% static 'patients/assets/images/svg/word.svg" alt="">-->
                                                        </div>
                                                        <div class="doctitle">
                                                            <div class="docname">example-file.docs</div>
                                                            <div class="docsize">217kb</div>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="doclist">
                                                        <div class="docicon">
<!--                                                            <img src="{% static 'patients/assets/images/svg/excel.svg" alt="">-->
                                                        </div>
                                                        <div class="doctitle">
                                                            <div class="docname">example-file.xlxs</div>
                                                            <div class="docsize">217kb</div>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="doclist">
                                                        <div class="docicon">
<!--                                                            <img src="{% static 'patients/assets/images/svg/powerpoint.svg" alt="">-->
                                                        </div>
                                                        <div class="doctitle">
                                                            <div class="docname">example-file.pptx</div>
                                                            <div class="docsize">217kb</div>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="doclistall">View All</div>
                                                </li>
                                               
                                            </ul> 
                                        </div>
                                    </div>
                                </div>
        
                                <div class="card">
                                    <div class="card-header" id="headingFour">
                                        <div class="card-title collapsed  d-flex justify-content-between align-items-center" role="button"  data-toggle="collapse" data-target="#collapseFour"
                                            aria-expanded="false" aria-controls="collapseFour">
                                            <div class="acpanel__heading">
                                                <div class="acpanel__left">
                                                    <span><i class="mdi mdi-settings-outline"></i></span>
                                                    <span>Settings</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="collapseFour" class="collapse" aria-labelledby="headingFour" data-parent="#accordionExample">
                                        <div class="card-body">
        
                                            <ul class="list-unstyled">
                                                <li>
                                                    <div class="setting-list">
                                                        <div class="setting-list-name">Media Auto Download</div>
                                                        <div class="setting-list-switch">
                                                            <label class="material-switch">
                                                                <input type="checkbox">
                                                                <span></span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="setting-list">
                                                        <div class="setting-list-name">Mute Conversation</div>
                                                        <div class="setting-list-switch">
                                                            <label class="material-switch">
                                                                <input type="checkbox">
                                                                <span></span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="setting-list">
                                                        <div class="setting-list-name">Notifications</div>
                                                        <div class="setting-list-switch">
                                                            <label class="material-switch">
                                                                <input type="checkbox">
                                                                <span></span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="setting-list">
                                                        <div class="setting-list-name">Block</div>
                                                        <div class="setting-list-switch">
                                                            <label class="material-switch">
                                                                <input type="checkbox">
                                                                <span></span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
        
                            
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
$(document).ready(function(){
    $('#caMainTab a[href="{% url "patients:consultations"%}"]').addClass('active');

    let dataList = [];
    let chatData_list = [];
    let old_active_id = null;
    let shoing_conversation_id = null;


    function getConsultantListList(){

        jQuery.ajax({
            'url': '/api/getPatientConsultations/',
            'contentType': 'application/json',
            'async': false,
            'method': 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Token " + jQuery.cookie('Token'));
            },
        }).done((response)=>{
            console.log(response)
            dataList = response;
        });

        let totalLi = '';
        for(var i=0; i < dataList.length; i++){
            let data = dataList[i];
            if(i ==0){
                consultationList(data.id)

            }
            const liDesign = `
                <li id="activate_list${data.id}">
                    <div id="activate_class${data.id}" class="conversation">
                        <div class="user-avatar user-avatar-rounded offline">
                            <img src="${data.doctor_id.profile_pic}" alt="">
                        </div>
                        <div class="conversation__details">
                            <div class="conversation__name">
                                <div class="conversation__name--title">${data.doctor_id.full_name}</div>
                                <div class="conversation__time">${getDateOrName(data.consultation_date_time)}</div>
                            </div>
                            <div class="conversation__message">
                                <div class="conversation__message-preview">
                                    <span class="tick">
                                        <img src="{% static 'patients/assets/images/tick/tick-send.svg" alt="">
                                    </span>
                                    Hello! Are you free today?
                                </div>
                            </div>
                        </div>
                    </div>
                </li>`;
            totalLi += liDesign;
        }

        $('#consultation_doctor_list').html(totalLi);
        
    }
    getConsultantListList()
    
    $('#consultation_doctor_list').on('click', 'li', function(){
        let id = $(this).attr('id');
        console.log(id)
        return consultationList(id.slice(13))
    })
    
    function consultationList(id){
        console.log(id);
        
        for(var i=0; i < dataList.length; i++){
            console.log(dataList[i]);
            if(dataList[i].id == id){
                shoing_conversation_id = dataList[i].id;
                getChatData(shoing_conversation_id);
                console.log('shoing_conversation_id', shoing_conversation_id);
                $('#conversation_doc').html(dataList[i].doctor_id.full_name);
                break;
            }
        }
        let activate_class = '#activate_class';

        if(old_active_id == null){
            old_active_id = id;
        }
        else{
            $(activate_class + old_active_id).removeClass('active');
            old_active_id = id;
        }
        $(activate_class + id).addClass('active');
        

    }

    function getDateOrName(date){
        let dateTime = new Date(date);
        let today_date_time = Date.now();
        let yesterday = today_date_time - (1000*60*60*24);
        let past_day_of_yesterdey = yesterday - (1000*60*60*24);
        if(dateTime.getTime() >= yesterday){
            return "today";
        }
        else if( dateTime.getTime() > past_day_of_yesterdey){
            return "yesterday";
        }
        else{
            let day = dateTime.getDate()
            let month = dateTime.getMonth()
            let year = dateTime.getFullYear()
            return day + "-" + month + "-" + year;
        }
    }

function getChatData(consult_id){
    const get_url = '/api/consultant_chats/?cons_id='+ consult_id;
    console.log(get_url)
    $.ajax({
            'url': get_url,
            'contentType': 'application/json',
            'async': false,
            'method': 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Token " + $.cookie('Token'));
            },
        }).done((response)=>{
            chatData_list= response;
        })
    
    return showList();
}

function showList(){
    let liLists = '';
    for(var i=0; i < chatData_list.length; i++){
        const data = chatData_list[i];
        
        if(data.user == 'D'){
            const li = `
            <div class="ca-received">
                <div class="user-avatar user-avatar-sm user-avatar-rounded online">
                    <img src="{% static 'patients/assets/images/layer-14@2x.png' %}" alt="">
                </div>
                <div class="ca-received__msg-group">
                    <div class="ca-received__msgwrapper">
                        <div class="ca-received__msg">${data.message}</div>

                    </div>
                    <div class="metadata">
                        <span class="time">${data.message_date_time}</span>
                    </div>
                </div>
            </div>`;

            liLists += li;
        }
        else{
            const li = `
            <div class="ca-send">

                <div class="ca-send__msg-group">
                    <div class="ca-send__msgwrapper">
                        <div class="ca-send__msg">${data.message}</div>
                    </div>
                    <div class="metadata">
                        <span class="time">${data.message_date_time}</span>

                    </div>

                </div>
                <div class="user-avatar user-avatar-sm user-avatar-rounded online">
                    <img src="{% static 'patients/assets/images/user/250/02.jpg' %}" alt="">
                </div>
            </div>
                `;

            liLists += li;
        }
    }
    $('#chatDiv').html(liLists);
    if(old_active_id == null){
        if(chatData_list.length !=0){

            old_active_id = chatData_list[0].consultation_id;
        }
    }
    else{
        
    }
}
setInterval(function(){ 
    
  getChatData(shoing_conversation_id); }, 1000); 


function sendMessage(consult_id){
    let data = {
        user: 'P',
        message: $('#typed-message').val(),
        attachment: false,
        //attachment_file:'file'
        seen: false,
        delivered: false,
        consultation_id: consult_id
    }
    $.ajax({
        url: '/api/consultant_chats/',
        data: JSON.stringify(data),
        method: 'POST',
        contentType: 'application/json',
        beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "Token " + $.cookie('Token'));
        },
    }).done((response)=>{
        console.log("postrequest response -", response);
    }).fail((err, error, wrong) => {
        console.log(err)

    })

}
    $('#messege_form').submit(function(e){
        e.preventDefault();
        e.stopImmediatePropagation();
        sendMessage()

    })
    $('#sendButton').click(function(){
        let values = $('#typed-message').val();
        if(values.length >0){
            sendMessage(old_active_id)
        }
        $('#typed-message').val('')
    })
})
</script>
{% endblock %}