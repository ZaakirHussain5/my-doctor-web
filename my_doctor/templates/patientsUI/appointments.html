{% extends 'new_patient_layout.html'%}
{% load static%}
{% block content %} 
<div class="ca-content__chatstab"> 
    <div class="ca-content__callstab" style="padding-top: 0;">
        <div class="conversation-panel__body ps">
            <div class="container">
                <div class="card">
                    <div class="card-header">
                        <h4>Appointments</h4>
                    </div>
                    <div class="mob-list">
                        <div class="sidebar-userlist ps ps--active-y">
                            <ul class="list-unstyled appointmentList">
                                <li>
                                    <div class="calllist">
                                        <div class="user-avatar user-avatar-rounded online">
                                            <img class="img-fluid" src="http://127.0.0.1:8000/media/author-thumb-5.jpg" alt="">
                                        </div>
                                        <div class="calllist__details">
                                            <div class="calllist__details--name">Dr. Andrew</div>
                                            <div class="calllist__details--info mt-1">
                                                <span>Head Ache<br>12/11/2020 10:20AM</span>
                                                <span></span>
                                            </div>
                                        </div>

                                        <div class="calllist__actions">
                                            <div class="iconbox btn-hovered-light" >
                                                <i class="iconbox__icon mdi mdi-video text-danger"></i>
                                            </div>
                                            <div class="iconbox btn-hovered-light" data-toggle="modal" data-target="#editApp">
                                                <i class="iconbox__icon mdi mdi-pencil-outline text-primary"></i>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="calllist">
                                        <div class="user-avatar user-avatar-rounded online">
                                            <img class="img-fluid" src="http://127.0.0.1:8000/media/author-thumb-5.jpg" alt="">
                                        </div>
                                        <div class="calllist__details">
                                            <div class="calllist__details--name">Dr. Andrew</div>
                                            <div class="calllist__details--info mt-1">
                                                <span>Stomach Ache<br>12/11/2020 10:20AM</span>
                                                <span></span>
                                            </div>
                                        </div>

                                        <div class="calllist__actions">
                                            <div class="iconbox btn-hovered-light">
                                                <i class="iconbox__icon mdi mdi-file text-primary"></i>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                    </div>
                    </div>
                </div>
            </div>
        </div>
</div>
</div>
<div class="modal new-message-dialog" id="editApp" tabindex="-1" role="dialog" aria-labelledby="newMsgModal"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                            <h5>Edit Appointment</h5>
                       
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        
                    </div>
                    <div class="modal-body">
                        <div class="d-flex flex-wrap align-content-center" style="justify-content: center;">
                            <ul class="nav nav-pills my-3" id="caCallsTabInside" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="all-calls-tab" data-toggle="pill" href="#cancel-app"
                                        role="tab" aria-controls="all-calls" aria-selected="false">Cancel</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link " id="missed-calls-tab" data-toggle="pill" href="#resc-app"
                                        role="tab" aria-controls="missed-calls" aria-selected="true">Reschedule</a>
                                </li>
                            </ul>
                        </div>
                        <div class="tab-content">
                            <div class="tab-pane  fade show active" id="cancel-app" role="tabpanel"
                                aria-labelledby="pills-contact-tab">
                                 <form id="mediaclForms">
                            <div class="form-group">
                                <label for="ConsultingAbout">Reason</label>
                                <textarea name="description" class="form-control" id="ConsultingAbout" rows="7" placeholder="Describe your Reason" style="font-size: medium;"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn mfb-component__button--main"
                                style="width:100%; border-radius:30px" id="ConfirmClick">Cancel Appointment</button>
                            </div>
                        </form>
                            </div>
                            <div class="tab-pane  fade" id="resc-app" role="tabpanel"
                            aria-labelledby="pills-contact-tab">
                          
                                <div class="row">
                                    <div class="col-md-7 text-center">
                                        <div class="ca-profile-thumb" style="height: auto;">
                                        <div class="ca-profile-info">
                                    <div class="ca-profile-pic"><img class="img-fluid"
                                            id="summaryProfile" src="http://127.0.0.1:8000/media/group-12x_CENyikq.png"
                                            alt=""></div>
                                     </div>
                                     <div class="ca-overlay"></div>
                                        </div>
                                        
                                    </div>
                                    <div class="col-md-5 text-center mt-5">
                                        <h5>Dr. Das</h5>
                                        <p>Dietitian</p>
                                    </div>
                                </div>
                                

                               
                            <div class="form-group mt-5">
                                <label>Select Date</label>
                                <div class="input-group">
                                    <input type="date" class="form-control">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-primary">
                                            Check Availablity
                                        </button>
                                    </span>
                                </div>
                                
                            </div>
                            <div class="form-group text-center">
                                <strong class="text-primary">
                                    <i class="mdi mdi-check-circle-outline"></i> Doctor Available at 12:00 PM on 12/08/2020
                                </strong>
                            </div>
                            <div class="form-group">
                                <button type="button" style="width:100%; border-radius:30px" class="btn btn-primary btn-block">
                                    Book Appointment
                                </button>
                            </div>
                        </div>
                            </div>
                       
                    </div>
                    
                </div>
            </div>
        </div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function(){
        $('#caMainTab a[href="{% url "patients:appointments"%} .conversation"]').addClass('active');
        
        
        let previousAppoinment = $('#previousAppoinment').DataTable({
            ajax: {
                url: '/api/getAppoinmentHistory',
                dataSrc: '',
                'beforeSend': function (request) {
                    request.setRequestHeader("Authorization", 'Token '+jQuery.cookie('Token'));
                },
            },
            columns:[
                {
                    data:'appointment_date',
                },
                {
                    data:'appointment_time',
                    render:function(data){
                        return tConvert(data)
                    }
                },
                {
                  data: "doctor",
                  render: function (doctor){
                      return `
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="user-avatar user-avatar-rounded">
                                        <img class="img-fluid" src="${doctor.profile_pic}" alt="">
                                    </div>
                                </div>
                                <div class="col-md-10">
                                    <div class="ml-2 ca-call-history__left--title">
                                        <div>${doctor.full_name}</div>
                                        <span class="text-secondary">${doctor.specialist_type}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                      `;
                  }
                },
                
                {
                    data : 'Description'
                },
                
            ],
              language: {
                  lengthMenu: "_MENU_",
                  search: "",
              }
        })

        function tConvert(time) {
            // Check correct time format and split into components
            time = time.toString().match(/^([01]\d|2[0-3])(:)([0-5]\d)(:[0-5]\d)?$/) || [time];

            if (time.length > 1) { // If time format correct
                time = time.slice(1);  // Remove full string match value
                time[5] = +time[0] < 12 ? ' AM' : ' PM'; // Set AM/PM
                time[0] = +time[0] % 12 || 12; // Adjust hours
            }
            return time.join(''); // return adjusted time or original string
        }
        

        $.ajax({
            url: '/api/getUpcomingAppoinment',
            method: 'GET',
            contentType: 'application/json',
            'beforeSend': function (request) {
                request.setRequestHeader("Authorization", 'Token '+jQuery.cookie('Token'));
            },
        }).done((response)=>{
            let li = ''
            response.map(function(index){
                li += `
                <li>
                    <div class="calllist">
                        <div class="user-avatar user-avatar-rounded online">
                            <img class="img-fluid" src="${!index.doctor.profile_pic || index.doctor.profile_pic == '' ? '/media/logos/anonymous-doctor.png':index.doctor.profile_pic}" alt="">
                        </div>
                        <div class="calllist__details">
                            <div class="calllist__details--name">${index.doctor.full_name}</div>
                            <div class="calllist__details--info mt-1">
                                <span>${index.doctor.specialist_type}<br>${index.appointment_date}</span>
                                <span></span>
                            </div>
                        </div>

                        <div class="calllist__actions">
                            <div class="iconbox btn-hovered-light" >
                                <i class="iconbox__icon mdi mdi-video text-danger"></i>
                            </div>
                            <div class="iconbox btn-hovered-light" data-toggle="modal" data-target="#editApp">
                                <i class="iconbox__icon mdi mdi-pencil-outline text-primary"></i>
                            </div>
                        </div>
                    </div>
                </li>
                `;
            })

            $('.appointmentList').html(li)
        })
        .fail((err)=>{
            console.log(err);
        })
        // let upcoming = $('#upcoming').DataTable({
        //     ajax: {
        //         url: '/api/getUpcomingAppoinment',
        //         dataSrc: '',
        //         'beforeSend': function (request) {
        //             request.setRequestHeader("Authorization", 'Token '+jQuery.cookie('Token'));
        //         },
        //     },
        //     columns:[
        //         {
        //             data:'appointment_date',
        //         },
        //         {
        //             data:'appointment_time',
        //             render:function(data){
        //                 return tConvert(data)
        //             }
        //         },
        //         {
        //           data: "doctor",
        //           render: function (doctor){
        //               return `
        //                 <div class="card-body p-0">
        //                     <div class="row">
        //                         <div class="col-md-2">
        //                             <div class="user-avatar user-avatar-rounded">
        //                                 <img class="img-fluid" src="${doctor.profile_pic}" alt="">
        //                             </div>
        //                         </div>
        //                         <div class="col-md-10">
        //                             <div class="ml-2 ca-call-history__left--title">
        //                                 <div>${doctor.full_name}</div>
        //                                 <span class="text-secondary">${doctor.specialist_type}</span>
        //                             </div>
        //                         </div>
        //                     </div>
        //                 </div>
        //               `;
        //           }
        //         },
        //         {
        //             data : 'Description'
        //         },
        //         {
        //             data:'id',
        //             render:function(data,type,app){
        //                 return `
        //                 <div class="row">
        //                     <div class="col-md-6 text-center">
        //                         <button type="button" class="btn btn-danger btn-sm call" data-const="${app.id}" data-doctor="${app.doctor.id}" style="border-radius:50%">
        //                             <i class="mdi mdi-video text-light"></i>
        //                             </button><br>
        //                             <small class="">Call</small>
        //                     </div>
        //                     <div class="col-md-6 text-center">
        //                         <button type='button' class='btn btn-primary btn-sm' style="border-radius:50%" data-toggle="modal" data-target="#editApp">
        //                                 <i class="mdi mdi-square-edit-outline text-light"></i>
        //                         </button><br>
        //                         <small class="">Edit</small>
        //                     </div>
        //                 </div>
                        
                                   
        //                 `
        //             }
        //         }
                
        //     ],
        //       language: {
        //           lengthMenu: "_MENU_",
        //           search: "",
        //       }
        // })

        $('#upcoming').on('click','.call',function(){
            var button = $(this)
            $.ajax({
                url:`/api/CallDoctor?doctor_id=${button.attr('data-doctor')}&const=${button.attr('data-const')}`,
                method:'POST',
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", 'Token '+jQuery.cookie('Token'));
                },
                success:function(response){
                    window.location.href=`/api/VideoCall?user=pat&session=${response.id}&doctor=${button.attr('data-doctor')}&appointment=${button.attr('data-const')}`
                },
                error:function(response){
                    console.log(response)
                }
            })
        })
        // VARIABLES...
        // let dataList = [];
        // let old_active_id = null;


        // function getAppoinmentList(){
        //     $.ajax({
        //         'url': '/api/getPatientsAppointments/',
        //         'contentType': 'application/json',
        //         'async': false,
        //         'method': 'GET',
        //         beforeSend: function (xhr) {
        //             xhr.setRequestHeader("Authorization", "Token " + $.cookie('Token'));
        //         },
        //     }).done((response)=>{
        //         console.log('response response', response);
        //         dataList = response;
        //     });
        //     console.log('data list is', dataList);
        //     let totalLi = '';
        //     for(var i=0; i < dataList.length; i++){
        //         let data = dataList[i];
        //         const liDesign = `<li id="patient${data.id}"><div class="calllist" id="patientDiv${data.id}">
        //                     <div class="user-avatar user-avatar-rounded online">
        //                         <img src="${data.doctor.profile_pic}" alt="">
        //                     </div>
        //                     <div class="calllist__details">
        //                         <div class="calllist__details--name">${data['doctor']['full_name']}</div>
        //                         <div class="calllist__details--info">
        //                             <span><i class="mdi mdi-call-received"></i></span>
        //                             <span>${data.appointment_date} at ${data.appointment_time}</span>
        //                         </div>
        //                     </div>
        //                     <div class="calllist__actions">
        //                         <div class="iconbox btn-hovered-light">
        //                             <i class="iconbox__icon mdi mdi-video-outline"></i>
        //                         </div>
        //                     </div>
        //                 </div>
        //             </li>`;
        //         totalLi += liDesign;
        //     }
        //     $('#appointment_list').html(totalLi);
        //     const liId = 'patient' + dataList[0].id;
        //     appoinmentList(liId);
        // }
        // getAppoinmentList()


        // function appoinmentList(id){

        //     let ID= id.slice(7)
        //     $('#'+id+' #patientDiv'+ID).addClass('active');
        //     if(old_active_id == null){
        //         old_active_id = '#patientDiv'+ID;
        //     }
        //     else{
        //         $(old_active_id).removeClass('active');
        //         old_active_id = '#patientDiv'+ID;
        //     }

        //     for(let i=0; i< dataList.length; i++){
        //         const index = dataList[i];
        //         if(index.id == ID){
        //             $("#doctor_image").attr('src', index.doctor.profile_pic);
        //             $(".ca-profile-name").html(index.doctor.full_name);
        //             $("#specialist__at").html(index.doctor.specialist_type);
        //             $("#speciality_at").html(index.doctor.specialist_type);
        //             $("#doctor_phone").html(index.doctor.phone_number);
        //             //$("#doctor_email").html(index.doctor.phone_number);
        //             $("#appointment_date").html(index.appointment_date);
        //             $("#appontment_time").html(index.appointment_time);
        //         }
        //     }

        // }

        // $('#appointment_list').on('click', 'li', function(){
        //     let id = $(this).attr('id');
        //     return appoinmentList(id)
        // })
    })
</script>
{% endblock %}